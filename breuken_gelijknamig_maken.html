<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gelijknamig maken â€“ Wiskunde Oefenplatform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1117; --surface: #1a1d27; --surface2: #20243a;
      --border: rgba(255,255,255,0.08); --text: #e8eaf0; --muted: #8891aa;
      --accent: #5b8dee; --success: #4cbb8a; --danger: #e05757; --warning: #f5c542;
      --radius: 14px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    body::before {
      content: ''; position: fixed; inset: 0;
      background: radial-gradient(ellipse 60% 40% at 20% 10%, rgba(91,141,238,.10) 0%, transparent 70%),
                  radial-gradient(ellipse 50% 50% at 80% 80%, rgba(76,187,138,.07) 0%, transparent 70%);
      pointer-events: none; z-index: 0;
    }
    .wrap { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; padding: 32px 20px 60px; }

    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; gap: 12px; flex-wrap: wrap; }
    .back-btn { display: inline-flex; align-items: center; gap: 8px; color: var(--muted); text-decoration: none; font-size: .88rem; font-weight: 600; padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px; transition: all .2s; }
    .back-btn:hover { color: var(--text); border-color: rgba(255,255,255,.2); }
    .page-title h1 { font-size: 1.3rem; font-weight: 800; }
    .page-title span { font-size: .78rem; color: var(--muted); }

    .progress-wrap { margin-bottom: 28px; }
    .progress-meta { display: flex; justify-content: space-between; font-size: .8rem; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
    .progress-track { height: 8px; background: var(--surface); border-radius: 99px; overflow: hidden; border: 1px solid var(--border); }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #a0c4ff); border-radius: 99px; transition: width .5s cubic-bezier(.4,0,.2,1); width: 0%; }

    .oefening-kaart { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 32px; animation: fadeIn .3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .vraag-label { font-size: .72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--muted); margin-bottom: 20px; display: block; }

    /* â”€â”€ OPGAVE: twee kolommen met verticale streep â”€â”€ */
    .opgave-grid {
      display: grid; grid-template-columns: 1fr 2px 1fr;
      background: var(--surface2); border: 1px solid var(--border); border-radius: 12px;
      overflow: hidden; margin-bottom: 32px; min-height: 100px;
    }
    .opgave-cel { display: flex; align-items: center; justify-content: center; padding: 20px 32px; }
    .opgave-div { background: rgba(255,255,255,.1); }

    /* Breuk weergave */
    .breuk-disp { display: inline-flex; flex-direction: column; align-items: center; font-size: 1.9rem; font-weight: 800; line-height: 1; }
    .breuk-disp .bt { padding: 4px 10px; }
    .breuk-disp .bs { width: 100%; min-width: 36px; height: 3px; background: var(--text); border-radius: 2px; margin: 5px 0; }
    .breuk-disp .bn { padding: 4px 10px; }
      .breuk-disp .neg { /* geen kleur voor negatief */ }

    /* â”€â”€ INVOER SECTIE: twee kolommen met verticale streep â”€â”€ */
    .invoer-grid {
      display: grid; grid-template-columns: 1fr 2px 1fr;
      margin-bottom: 4px;
    }
    .invoer-div { background: var(--border); }
    .breuk-kolom { display: flex; flex-direction: column; padding: 4px 16px; gap: 0; }

    /* Stap-rij: = [wrap] [+] */
    .stap-rij { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    .stap-eq { font-size: 1.3rem; font-weight: 700; color: var(--muted); width: 22px; text-align: center; flex-shrink: 0; }

    /* Invoer-wrap */
    .iv-wrap {
      flex: 1; min-height: 70px; min-width: 110px;
      background: var(--surface2); border: 2px solid var(--border); border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      cursor: text; transition: border-color .2s, background .2s; position: relative; padding: 6px 12px;
    }
    .iv-wrap.actief { border-color: var(--accent); background: rgba(91,141,238,.06); }
    .iv-wrap.correct { border-color: var(--success) !important; background: rgba(76,187,138,.08) !important; }
    .iv-wrap.fout    { border-color: var(--danger)  !important; background: rgba(224,87,87,.08) !important; }
    .iv-wrap.disabled { opacity: .65; cursor: not-allowed; pointer-events: none; }

    /* Buffer-span (teller die getypt wordt) */
    .iv-buf {
      font-size: 1.25rem; font-weight: 800; color: var(--text);
      min-width: 24px; text-align: center;
      display: inline-flex; align-items: center; justify-content: center;
    }
    /* Knipperend cursor enkel in actief veld */
    .iv-buf::after { content: ''; }
    .iv-wrap.actief .iv-buf::after { content: '|'; color: var(--accent); animation: blink 1s step-end infinite; margin-left: 1px; font-weight: 300; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

    /* Breuk-invoer (na /) */
    .iv-frac { display: inline-flex; flex-direction: column; align-items: center; }
    .iv-frac .iv-streep { width: 80%; min-width: 44px; height: 2px; background: var(--muted); border-radius: 2px; margin: 3px 0; }
    .iv-frac input {
      background: transparent; border: none; outline: none;
      font-family: 'Outfit', sans-serif; font-size: 1.25rem; font-weight: 800; color: var(--text);
      text-align: center; width: 70px; padding: 2px 4px; caret-color: var(--accent);
    }
    .iv-frac input::placeholder { color: transparent; }

    /* + knop */
    .plus-btn {
      width: 30px; height: 30px; border-radius: 50%;
      border: 2px solid rgba(91,141,238,.3); background: rgba(91,141,238,.1);
      color: var(--accent); font-size: 1.1rem; font-weight: 700;
      cursor: pointer; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      transition: all .2s; font-family: 'Outfit', sans-serif;
    }
    .plus-btn:hover:not(:disabled) { background: rgba(91,141,238,.22); border-color: var(--accent); }
    .plus-btn:disabled { opacity: .3; cursor: not-allowed; }

    .knoppen-rij { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px; }
    .btn { padding: 12px 22px; border: none; border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: .92rem; font-weight: 700; cursor: pointer; transition: all .2s; }
    .btn:disabled { opacity: .35; cursor: not-allowed; }
    .btn-primair { background: var(--accent); color: white; }
    .btn-primair:not(:disabled):hover { opacity: .85; transform: translateY(-1px); }
    .btn-succes { background: var(--success); color: #0c2e1c; }
    .btn-succes:not(:disabled):hover { opacity: .85; transform: translateY(-1px); }

    .feedback-box { margin-top: 20px; padding: 16px 20px; border-radius: 10px; font-size: .92rem; line-height: 1.7; display: none; animation: fadeIn .25s ease; }
    .feedback-box.succes { background: rgba(76,187,138,.1); border: 1px solid rgba(76,187,138,.3); color: var(--success); font-weight: 600; }
    .feedback-box.geel { background: rgba(245,197,66,.08); border: 1px solid rgba(245,197,66,.3); color: var(--warning); }
    .feedback-box.rood { background: rgba(224,87,87,.09); border: 1px solid rgba(224,87,87,.3); color: var(--danger); }

    .rekenregel-blok { margin-top: 16px; background: var(--surface2); border: 1px solid rgba(91,141,238,.2); border-radius: 10px; padding: 16px 20px; display: none; animation: fadeIn .25s ease; }
    .rekenregel-blok .rr-titel { font-size: .7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent); margin-bottom: 10px; }
    .rekenregel-blok ul { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .rekenregel-blok ul li { display: flex; gap: 10px; font-size: .88rem; color: var(--text); line-height: 1.55; }
    .rekenregel-blok ul li::before { content: 'â€¢'; color: var(--accent); font-size: 1.1rem; flex-shrink: 0; }
    .rr-opgelet { margin-top: 10px; font-size: .88rem; font-weight: 700; color: var(--warning); }

    .eindscherm { text-align: center; padding: 48px 24px; animation: fadeIn .4s ease; }
    .eind-emoji { font-size: 3.5rem; margin-bottom: 16px; }
    .eind-punten { font-size: 3rem; font-weight: 800; color: var(--accent); margin-bottom: 8px; }
    .eind-score-label { font-size: 1rem; color: var(--muted); margin-bottom: 16px; }
    .score-badge { display: inline-block; font-size: 2rem; font-weight: 800; padding: 10px 32px; border-radius: 12px; margin-bottom: 28px; }
    .score-badge.A { background: rgba(168,230,161,.15); color: #a8e6a1; border: 2px solid rgba(168,230,161,.4); }
    .score-badge.B { background: rgba(255,244,163,.12); color: #fff4a3; border: 2px solid rgba(255,244,163,.35); }
    .score-badge.C { background: rgba(255,203,164,.12); color: #ffcba4; border: 2px solid rgba(255,203,164,.35); }
    .eind-bericht { font-size: 1rem; color: var(--muted); margin-bottom: 28px; line-height: 1.6; }

    .b-inline { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; font-size: .9em; font-weight: 800; line-height: 1; margin: 0 4px; }
    .b-inline .bi-streep { width: 100%; min-width: 20px; height: 2px; background: currentColor; margin: 1px 0; }

    @media (max-width: 600px) {
      .opgave-grid { grid-template-columns: 1fr; }
      .invoer-grid  { grid-template-columns: 1fr; }
      .opgave-div, .invoer-div { height: 2px; width: auto; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <a href="index.html" class="back-btn">â† Terug naar oefeningen</a>
    <div class="page-title">
      <h1>ğŸ”€ Gelijknamig maken</h1>
      <span id="user-label">Laden...</span>
    </div>
  </header>

  <div class="progress-wrap">
    <div class="progress-meta">
      <span id="progress-tekst">Oefening 1 van 6</span>
      <span id="score-live">0 / 0</span>
    </div>
    <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
  </div>

  <div id="inhoud"></div>
</div>

<script type="module">
import { db } from './config.js';
import { doc, updateDoc, arrayUnion } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const TOTAAL = 6;
const TYPE_NR = 2;

let user = null, opgaven = [], huidigeIdx = 0;
let punten = 0, eerstePoging = 0, tweedePoging = 0, foutGegaan = 0, pogingTeller = 0;
let stappenB1 = [], stappenB2 = [];

// Globaal actief veld (voor keyboard-input)
// { kolomId, stapIdx, obj }  (obj = stap-object)
let actief = null;

/* â”€â”€â”€ Wiskunde helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const gcd = (a,b) => { a=Math.abs(a); b=Math.abs(b); while(b){let t=b;b=a%b;a=t;} return a; };
const lcm = (a,b) => Math.abs(a*b)/gcd(a,b);
const kgv = lcm;
const breukGelijk = (t1,n1,t2,n2) => t1*n2 === t2*n1;
const rand = (lo,hi) => Math.floor(Math.random()*(hi-lo+1))+lo;
const pick  = arr => arr[Math.floor(Math.random()*arr.length)];

/* â”€â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function checkLogin() {
  const s = localStorage.getItem('wiskunde_user');
  if(!s){ window.location.href='login.html'; return null; }
  try {
    const u = JSON.parse(s);
    if(u.isAdmin){ window.location.href='dashboard.html'; return null; }
    document.getElementById('user-label').textContent = u.naam||u.email;
    return u;
  } catch(e){ localStorage.removeItem('wiskunde_user'); window.location.href='login.html'; return null; }
}

/* â”€â”€â”€ Breuk genereren â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const NOEMERS = [2,3,4,5,6,7,8,9,10,15,20];

function irreducibel(neg=false) {
  let t,n;
  do { n=pick(NOEMERS); t=rand(1,n-1); } while(gcd(t,n)!==1);
  if(neg && Math.random()<.5) t=-t;
  return {t,n};
}

function vereenvoudigbaar(neg=false) {
  let t,n,att=0;
  do {
    if(++att>200) return irreducibel(neg);
    const b=irreducibel();
    const fs=[2,3,4,5].filter(f=>NOEMERS.includes(b.n*f)&&b.t*f<b.n*f);
    if(!fs.length) continue;
    const f=pick(fs); t=b.t*f; n=b.n*f;
  } while(gcd(t,n)===1||!NOEMERS.includes(n));
  if(neg && Math.random()<.5) t=-t;
  return {t,n};
}

function paar(g1,g2,max=300) {
  for(let i=0;i<max;i++){
    const b1=g1(),b2=g2();
    if(b1.n===b2.n) continue;
    const l=kgv(b1.n,b2.n);
    if(Math.abs(b1.t*(l/b1.n))<=100&&Math.abs(b2.t*(l/b2.n))<=100&&l<=100) return {b1,b2};
  }
  return {b1:{t:1,n:2},b2:{t:1,n:3}};
}

function genereerOpgaven() {
  const L=[];
  L.push({...paar(()=>irreducibel(),()=>irreducibel()),nr:1});
  L.push({...paar(()=>irreducibel(),()=>irreducibel()),nr:2});
  const neg3=Math.random()<.5;
  L.push({...paar(()=>irreducibel(neg3),()=>irreducibel(!neg3)),nr:3});
  const s4=Math.random()<.5;
  L.push({...paar(()=>s4?vereenvoudigbaar():irreducibel(),()=>s4?irreducibel():vereenvoudigbaar()),nr:4});
  L.push({...paar(()=>vereenvoudigbaar(true),()=>irreducibel()),nr:5});
  let b1_6,g;
  for(let i=0;i<300;i++){
    b1_6=irreducibel(); g=rand(2,10);
    const l=kgv(b1_6.n,1);
    if(Math.abs(b1_6.t*(l/b1_6.n))<=100&&Math.abs(g*l)<=100&&l<=100) break;
  }
  L.push({b1:b1_6,b2:{t:g,n:1},nr:6,isGeheel:true});
  return L;
}

/* â”€â”€â”€ Voortgang â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateVoortgang() {
  document.getElementById('progress-fill').style.width=(huidigeIdx/TOTAAL*100)+'%';
  document.getElementById('progress-tekst').textContent=huidigeIdx<TOTAAL?`Oefening ${huidigeIdx+1} van ${TOTAAL}`:'Klaar!';
  document.getElementById('score-live').textContent=`${punten} / ${huidigeIdx}`;
}

/* â”€â”€â”€ HTML helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function breukDisp(t,n) {
  const ts = t<0?`<span class="neg">${t}</span>`:`${t}`;
  if(n===1) return `<div class="breuk-disp"><div class="bt">${ts}</div></div>`;
  return `<div class="breuk-disp"><div class="bt">${ts}</div><div class="bs"></div><div class="bn">${n}</div></div>`;
}
function biHTML(t,n){ return `<span class="b-inline"><span>${t}</span><span class="bi-streep"></span><span>${n}</span></span>`; }

/* â”€â”€â”€ Stap-object aanmaken â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/*
  Elk stap-object heeft:
    teller, noemer  â€” null of getal
    fase            â€” 'buf' | 'frac'
    bufTekst        â€” string (wat leerling typt vÃ³Ã³r /)
    wrap            â€” .iv-wrap element
    bufSpan         â€” .iv-buf span
    fracDiv         â€” .iv-frac div (of null)
    nInput          â€” input voor noemer (of null)
    rij             â€” de .stap-rij
    plusBtn         â€” de + knop
*/
function maakStapObj(kolomId, stapIdx) {
  const wrap = document.createElement('div');
  wrap.className = 'iv-wrap';
  wrap.dataset.kol = kolomId;
  wrap.dataset.idx = stapIdx;

  const bufSpan = document.createElement('div');
  bufSpan.className = 'iv-buf';
  wrap.appendChild(bufSpan);

  const obj = {
    teller: null, noemer: null,
    fase: 'buf', bufTekst: '',
    wrap, bufSpan, fracDiv: null, nInput: null,
    rij: null, plusBtn: null
  };

  // Klik op wrap â†’ activeer
  wrap.addEventListener('mousedown', e => {
    if(wrap.classList.contains('disabled')) return;
    // Niet preventDefault als op een echte input geklikt wordt â€” laat browser focus werken
    const opInput = e.target.tagName === 'INPUT';
    if(!opInput) e.preventDefault();
    activeer(kolomId, stapIdx, obj);
    // In buffer-fase: geen native focusable element, keydown handler pakt het op
    // In frac-fase: als niet op een input geklikt, focus naar noemer
    if(!opInput && obj.fase==='frac' && obj.nInput) obj.nInput.focus();
  });

  return obj;
}

function activeer(kolomId, stapIdx, obj) {
  document.querySelectorAll('.iv-wrap').forEach(w=>w.classList.remove('actief'));
  obj.wrap.classList.add('actief');
  actief = { kolomId, stapIdx, obj };
}

function deactiveer() {
  document.querySelectorAll('.iv-wrap').forEach(w=>w.classList.remove('actief'));
  actief = null;
}

/* â”€â”€â”€ Keyboard handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('keydown', e => {
  if(!actief) return;
  const { kolomId, stapIdx, obj } = actief;
  if(obj.wrap.classList.contains('disabled')) return;

  // Als we in frac-fase zijn: teller en noemer hebben eigen keydown handlers.
  // De globale keydown hoeft hier niets te doen â€” laat native input werken.
  if(obj.fase==='frac') {
    return;
  }

  // Buffer-fase
  if(obj.fase==='buf') {
    if(/^[0-9]$/.test(e.key)) {
      e.preventDefault();
      obj.bufTekst += e.key;
      renderBuf(obj); syncData(kolomId, stapIdx, obj); updateCtrlKnop();
    } else if(e.key==='-' && obj.bufTekst==='') {
      e.preventDefault();
      obj.bufTekst='-'; renderBuf(obj);
    } else if(e.key==='/' && obj.bufTekst!=='' && obj.bufTekst!=='-') {
      e.preventDefault();
      obj.teller = parseInt(obj.bufTekst);
      bufNaarBreuk(kolomId, stapIdx, obj);
    } else if(e.key==='Backspace') {
      e.preventDefault();
      obj.bufTekst=obj.bufTekst.slice(0,-1);
      renderBuf(obj); syncData(kolomId, stapIdx, obj); updateCtrlKnop();
    }
  }
});

function renderBuf(obj) { obj.bufSpan.textContent = obj.bufTekst; }

// Globale mousedown: deactiveer als men buiten een iv-wrap klikt
document.addEventListener('mousedown', e => {
  if(!actief) return;
  const klikOpWrap = e.target.closest('.iv-wrap');
  if(!klikOpWrap) {
    // Buiten een wrap geklikt â†’ deactiveer
    document.querySelectorAll('.iv-wrap').forEach(w=>w.classList.remove('actief'));
    actief = null;
  }
  // Als op een andere wrap geklikt: die wrap's mousedown-handler regelt activatie
});

function bufNaarBreuk(kolomId, stapIdx, obj) {
  obj.bufSpan.style.display='none';
  const fd = document.createElement('div');
  fd.className='iv-frac';

  // Teller: echte input zodat leerling erin kan klikken en aanpassen
  const ti=document.createElement('input');
  ti.type='text'; ti.inputMode='numeric'; ti.autocomplete='off'; ti.spellcheck=false;
  ti.value=obj.teller; ti.dataset.deel='teller';
  // Breedte aanpassen aan inhoud
  ti.style.width='60px';

  const sd=document.createElement('div'); sd.className='iv-streep';

  const ni=document.createElement('input');
  ni.type='text'; ni.inputMode='numeric'; ni.autocomplete='off'; ni.spellcheck=false;
  ni.dataset.deel='noemer';

  fd.appendChild(ti); fd.appendChild(sd); fd.appendChild(ni);
  obj.wrap.appendChild(fd);
  obj.fracDiv=fd; obj.tInput=ti; obj.nInput=ni; obj.fase='frac';

  // Teller-input events
  ti.addEventListener('input', ()=>{
    const t=parseInt(ti.value);
    obj.teller=isNaN(t)?null:t;
    syncData(kolomId,stapIdx,obj); updateCtrlKnop();
  });
  ti.addEventListener('focus', ()=> activeer(kolomId,stapIdx,obj));
  // Backspace op lege teller-input â†’ terug naar buffer
  ti.addEventListener('keydown', e=>{
    if(e.key==='Backspace' && ti.value===''){
      e.preventDefault();
      breuknaarBuf(kolomId, stapIdx, obj);
    }
  });

  // Noemer-input events
  ni.addEventListener('input', ()=>{
    const n=parseInt(ni.value);
    obj.noemer=isNaN(n)?null:n;
    syncData(kolomId,stapIdx,obj); updateCtrlKnop();
  });
  ni.addEventListener('focus', ()=> activeer(kolomId,stapIdx,obj));
  // Backspace op lege noemer-input â†’ focus naar teller
  ni.addEventListener('keydown', e=>{
    if(e.key==='Backspace' && ni.value===''){
      e.preventDefault();
      ti.focus(); ti.setSelectionRange(ti.value.length, ti.value.length);
    }
  });
  // Geen blur-handlers: deactivering globaal via mousedown
  ni.focus();
}

function breuknaarBuf(kolomId, stapIdx, obj) {
  if(obj.fracDiv){ obj.fracDiv.remove(); obj.fracDiv=null; }
  // nInput is nu een echte input â€” verwijder ook tInput als die bestaat
  if(obj.tInput){ obj.tInput=null; } // referentie loskoppelen
  obj.nInput=null;
  obj.bufSpan.style.display='';
  obj.bufTekst = obj.teller!==null ? obj.teller.toString() : '';
  obj.teller=null; obj.noemer=null; obj.fase='buf';
  renderBuf(obj); syncData(kolomId,stapIdx,obj); updateCtrlKnop();
  // actief blijft hetzelfde object â€” geen nieuwe activeer() nodig
  // zorg wel dat de klasse aanwezig is (kan verdwenen zijn door focus-shift)
  document.querySelectorAll('.iv-wrap').forEach(w=>w.classList.remove('actief'));
  obj.wrap.classList.add('actief');
  actief = { kolomId, stapIdx, obj };
}

function syncData(kolomId, stapIdx, obj) {
  const st=kolomId==='b1'?stappenB1:stappenB2;
  if(st[stapIdx]){ st[stapIdx].teller=obj.teller; st[stapIdx].noemer=obj.noemer; }
}

function updateCtrlKnop() {
  const btn=document.getElementById('controleer-btn');
  if(!btn) return;
  btn.disabled=!(getLaatste(stappenB1)&&getLaatste(stappenB2));
}

function getLaatste(stappen) {
  for(let i=stappen.length-1;i>=0;i--){
    const s=stappen[i];
    if(s.teller!==null&&s.noemer!==null&&s.noemer!==0) return s;
  }
  return null;
}

/* â”€â”€â”€ Oefening opbouwen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toonOefening() {
  if(huidigeIdx>=TOTAAL){ toonEindscherm(); return; }
  pogingTeller=0; stappenB1=[]; stappenB2=[]; actief=null;
  updateVoortgang();
  const oef=opgaven[huidigeIdx];

  const ih=document.getElementById('inhoud'); ih.innerHTML='';
  const kaart=document.createElement('div'); kaart.className='oefening-kaart';

  // Label
  const lbl=document.createElement('span'); lbl.className='vraag-label'; lbl.textContent='Maak gelijknamig';
  kaart.appendChild(lbl);

  // Opgave grid
  const og=document.createElement('div'); og.className='opgave-grid';
  const oc1=document.createElement('div'); oc1.className='opgave-cel'; oc1.innerHTML=breukDisp(oef.b1.t,oef.b1.n);
  const od=document.createElement('div'); od.className='opgave-div';
  const oc2=document.createElement('div'); oc2.className='opgave-cel';
  oc2.innerHTML=oef.isGeheel?`<div class="breuk-disp"><div class="bt">${oef.b2.t}</div></div>`:breukDisp(oef.b2.t,oef.b2.n);
  og.appendChild(oc1); og.appendChild(od); og.appendChild(oc2);
  kaart.appendChild(og);

  // Invoer grid
  const ig=document.createElement('div'); ig.className='invoer-grid';
  const kol1=maakKolom('b1',oef);
  const id=document.createElement('div'); id.className='invoer-div';
  const kol2=maakKolom('b2',oef);
  ig.appendChild(kol1); ig.appendChild(id); ig.appendChild(kol2);
  kaart.appendChild(ig);

  // Knoppen
  const kr=document.createElement('div'); kr.className='knoppen-rij';
  const cb=document.createElement('button'); cb.className='btn btn-primair'; cb.id='controleer-btn'; cb.textContent='Controleer'; cb.disabled=true;
  const vb=document.createElement('button'); vb.className='btn btn-succes'; vb.id='volgende-btn'; vb.textContent='Volgende oefening â†’'; vb.style.display='none';
  kr.appendChild(cb); kr.appendChild(vb); kaart.appendChild(kr);

  const fb=document.createElement('div'); fb.className='feedback-box'; fb.id='feedback-box'; kaart.appendChild(fb);
  const rr=document.createElement('div'); rr.className='rekenregel-blok'; rr.id='rr-blok'; kaart.appendChild(rr);

  // Info-tekst
  const info=document.createElement('p');
  info.style.cssText='font-size:.78rem;color:var(--muted);margin-top:10px;margin-bottom:0;';
  info.textContent='Druk op + voor een extra tussenstap als dat nodig is.';
  kaart.appendChild(info);

  ih.appendChild(kaart);
  cb.addEventListener('click', controleer);
  vb.addEventListener('click', ()=>toonOefening());

  // Focus eerste veld
  setTimeout(()=>{
    if(stappenB1.length>0) activeer('b1',0,stappenB1[0]);
  },60);
}

function maakKolom(kolomId, oef) {
  const kol=document.createElement('div'); kol.className='breuk-kolom'; kol.id=`kol-${kolomId}`;
  voegStapToe(kolomId, kol, oef);
  return kol;
}

function voegStapToe(kolomId, kol, oef) {
  const stappen=kolomId==='b1'?stappenB1:stappenB2;
  const idx=stappen.length;

  const rij=document.createElement('div'); rij.className='stap-rij';
  const eq=document.createElement('div'); eq.className='stap-eq'; eq.textContent='=';
  rij.appendChild(eq);

  const obj=maakStapObj(kolomId,idx);
  rij.appendChild(obj.wrap);

  const pb=document.createElement('button'); pb.className='plus-btn'; pb.textContent='+'; pb.title='Extra tussenstap toevoegen';
  rij.appendChild(pb);
  obj.rij=rij; obj.plusBtn=pb;

  const stapData={teller:null,noemer:null,obj,rij,plusBtn:pb};
  stappen.push(stapData);

  pb.addEventListener('click',()=>{
    if(stappen.length>=5) return;
    // Verberg huidige + knop
    pb.style.display='none';
    // Voeg stap toe enkel aan deze kolom
    voegStapToe(kolomId,kol,oef);
    // Disable als max bereikt
    if(stappen.length>=5) stappen[stappen.length-1].plusBtn.disabled=true;
  });

  if(stappen.length>=5) pb.disabled=true;
  kol.appendChild(rij);
}

/* â”€â”€â”€ Controleer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function controleer() {
  const oef=opgaven[huidigeIdx];
  const fb=document.getElementById('feedback-box');
  const rr=document.getElementById('rr-blok');
  const cb=document.getElementById('controleer-btn');
  const vb=document.getElementById('volgende-btn');

  const antB1=getLaatste(stappenB1);
  const antB2=getLaatste(stappenB2);
  const tusB1=stappenB1.slice(0,stappenB1.indexOf(antB1));
  const tusB2=stappenB2.slice(0,stappenB2.indexOf(antB2));

  const b1=oef.b1;
  const b2=oef.isGeheel?{t:oef.b2.t,n:1}:oef.b2;

  // Valideer tussenstappen
  const foutT1=tusB1.filter(s=>s.teller!==null&&s.noemer!==null&&!breukGelijk(s.teller,s.noemer,b1.t,b1.n));
  const foutT2=tusB2.filter(s=>s.teller!==null&&s.noemer!==null&&!breukGelijk(s.teller,s.noemer,b2.t,b2.n));
  const tusOk=foutT1.length===0&&foutT2.length===0;

  // Valideer antwoorden
  const zelfdN=antB1&&antB2&&antB1.noemer===antB2.noemer;
  const aOk1=zelfdN&&breukGelijk(antB1.teller,antB1.noemer,b1.t,b1.n);
  const aOk2=zelfdN&&breukGelijk(antB2.teller,antB2.noemer,b2.t,b2.n);
  const antOk=aOk1&&aOk2;

  // Markeer stappen
  markeer(tusB1,tusB2,antB1,antB2,foutT1,foutT2,aOk1,aOk2,antOk&&tusOk);

  /* â”€â”€ Alles goed â”€â”€ */
  if(antOk && tusOk) {
    if(pogingTeller===0){punten+=1;eerstePoging++;}else{punten+=.5;tweedePoging++;}
    huidigeIdx++;
    fb.className='feedback-box succes';
    fb.innerHTML=pogingTeller===0?'âœ… Correct! Goed gedaan!':'âœ… Correct bij de tweede poging!';
    fb.style.display='block'; rr.style.display='none';
    cb.style.display='none'; vb.style.display='inline-block';
    vergrendel(); updateVoortgang();
    return;
  }

  /* â”€â”€ Antwoord juist, tussenstappen fout â”€â”€ */
  if(antOk && !tusOk) {
    if(pogingTeller===0) {
      fb.className='feedback-box geel';
      fb.innerHTML='Je hebt het juiste antwoord, maar niet de juiste tussenstappen. Pas de tussenstappen aan.';
      fb.style.display='block'; rr.style.display='none';
      pogingTeller=1;
      setTimeout(()=>{ smartReset(foutT1,foutT2,b1,b2,oef); updateCtrlKnop(); },900);
    } else {
      foutGegaan++; huidigeIdx++;
      fb.className='feedback-box rood';
      fb.innerHTML='Je hebt het juiste antwoord, maar niet de juiste tussenstappen. Daarom wordt deze oefening fout gerekend.';
      fb.style.display='block'; rr.style.display='none';
      cb.style.display='none'; vb.style.display='inline-block';
      vergrendel(); updateVoortgang();
    }
    return;
  }

  /* â”€â”€ Fout antwoord â”€â”€ */
  if(pogingTeller===0) {
    fb.className='feedback-box geel';
    fb.innerHTML='Je antwoord is niet juist. Bekijk de rekenregel en probeer opnieuw.';
    fb.style.display='block';
    rr.innerHTML=`<div class="rr-titel">REKENREGEL</div><ul>
      <li>Vereenvoudig eerst de breuken.</li>
      <li>Bereken het kleinste gemeenschappelijk veelvoud van de noemers.</li>
      <li>Schrijf elke breuk met als noemer dit kleinste gemeenschappelijk veelvoud.</li>
    </ul><div class="rr-opgelet">Let op het toestandsteken!</div>`;
    rr.style.display='block';
    pogingTeller=1;
    setTimeout(()=>{ smartReset(foutT1,foutT2,b1,b2,oef); updateCtrlKnop(); },900);
  } else {
    foutGegaan++; huidigeIdx++;
    rr.style.display='none';
    fb.className='feedback-box rood';
    fb.innerHTML=defFeedback(antB1,antB2,oef);
    fb.style.display='block';
    cb.style.display='none'; vb.style.display='inline-block';
    vergrendel(); updateVoortgang();
  }
}

/* â”€â”€â”€ Markeren â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function markeer(tusB1,tusB2,antB1,antB2,foutT1,foutT2,aOk1,aOk2,allesGoed) {
  const setF1=new Set(foutT1), setF2=new Set(foutT2);
  for(const s of tusB1){ s.obj.wrap.classList.toggle('fout',setF1.has(s)); if(allesGoed){s.obj.wrap.classList.remove('fout');s.obj.wrap.classList.add('correct');} }
  for(const s of tusB2){ s.obj.wrap.classList.toggle('fout',setF2.has(s)); if(allesGoed){s.obj.wrap.classList.remove('fout');s.obj.wrap.classList.add('correct');} }
  if(antB1){ antB1.obj.wrap.classList.toggle('correct',aOk1); antB1.obj.wrap.classList.toggle('fout',!aOk1); }
  if(antB2){ antB2.obj.wrap.classList.toggle('correct',aOk2); antB2.obj.wrap.classList.toggle('fout',!aOk2); }
}

/* â”€â”€â”€ Smart reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Verwijder vanaf de eerste foute tussenstap en alles daarna.
// Juiste tussenstappen Ã©n een juist antwoord (met juiste bovenliggende stappen) blijven staan.
function smartReset(foutT1, foutT2, b1, b2, oef) {
  // Bepaal per kolom welk antwoord correct is
  const antB1=getLaatste(stappenB1);
  const antB2=getLaatste(stappenB2);
  const zelfdN=antB1&&antB2&&antB1.noemer===antB2.noemer;
  const aOk1=zelfdN&&breukGelijk(antB1.teller,antB1.noemer,b1.t,b1.n);
  const aOk2=zelfdN&&breukGelijk(antB2.teller,antB2.noemer,b2.t,b2.n);

  ['b1','b2'].forEach(kolomId=>{
    const stappen=kolomId==='b1'?stappenB1:stappenB2;
    const foutSet=new Set(kolomId==='b1'?foutT1:foutT2);
    const antwoordOk=kolomId==='b1'?aOk1:aOk2;
    const kol=document.getElementById(`kol-${kolomId}`);

    const antwoord=getLaatste(stappen);
    const antIdx=stappen.indexOf(antwoord);

    // Zoek de eerste foute tussenstap
    let eersteHouteIdx=-1;
    for(let i=0;i<antIdx;i++){
      if(foutSet.has(stappen[i])){ eersteHouteIdx=i; break; }
    }

    // Als er een foute tussenstap is: verwijder vanaf die index
    // Als er geen foute tussenstap is maar antwoord fout: verwijder alleen antwoord
    // Als antwoord juist Ã©n alle tussenstappen juist: laat alles staan (mag niet hier komen, maar voor zekerheid)
    let verwijderVanaf;
    if(eersteHouteIdx>=0) {
      verwijderVanaf=eersteHouteIdx;
    } else if(!antwoordOk) {
      verwijderVanaf=antIdx; // verwijder alleen het antwoord
    } else {
      // Antwoord juist, tussenstappen juist: niets verwijderen (niet verwacht in smartReset)
      stappen.forEach(s=>{ s.obj.wrap.classList.remove('fout','actief','disabled'); });
      return;
    }

    // Verwijder rijen
    const teVerw=stappen.slice(verwijderVanaf);
    teVerw.forEach(s=>s.rij.remove());
    stappen.splice(verwijderVanaf);

    // Herstel plusBtn van de nu-laatste stap
    if(stappen.length>0) {
      const laatste=stappen[stappen.length-1];
      laatste.plusBtn.style.display='flex';
      laatste.plusBtn.disabled=stappen.length>=5;
    }

    // Verwijder fout/correct klassen van overgebleven stappen
    stappen.forEach(s=>{ s.obj.wrap.classList.remove('fout','correct','actief','disabled'); });

    // Voeg Ã©Ã©n nieuwe lege stap toe
    voegStapToe(kolomId, kol, oef);
  });

  // Focus op eerste nieuw veld van b1
  const nieuw=stappenB1[stappenB1.length-1];
  if(nieuw) activeer('b1', stappenB1.length-1, nieuw);
}

function vergrendel() {
  document.querySelectorAll('.iv-wrap').forEach(w=>{ w.classList.add('disabled'); w.querySelectorAll('input').forEach(i=>i.disabled=true); });
  document.querySelectorAll('.plus-btn').forEach(b=>b.disabled=true);
  actief=null;
}

/* â”€â”€â”€ Definitieve feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function defFeedback(antB1,antB2,oef) {
  const b1=oef.b1, b2=oef.isGeheel?{t:oef.b2.t,n:1}:oef.b2;
  const l=kgv(b1.n,b2.n);
  const cT1=b1.t*(l/b1.n), cT2=b2.t*(l/b2.n);
  const cB1=biHTML(cT1,l), cB2=biHTML(cT2,l);

  if(!antB1||!antB2||antB1.noemer!==antB2.noemer)
    return `Je antwoord is niet juist. Gelijknamige breuken hebben dezelfde noemer. Dat is bij jou niet het geval.<br>Het juiste antwoord is ${cB1} en ${cB2}.`;

  const ok1=breukGelijk(antB1.teller,antB1.noemer,b1.t,b1.n);
  const ok2=breukGelijk(antB2.teller,antB2.noemer,b2.t,b2.n);
  const aOk1=Math.abs(antB1.teller)*Math.abs(b1.n)===Math.abs(b1.t)*Math.abs(antB1.noemer);
  const aOk2=Math.abs(antB2.teller)*Math.abs(b2.n)===Math.abs(b2.t)*Math.abs(antB2.noemer);
  const alleenTeken=(!ok1?aOk1:true)&&(!ok2?aOk2:true)&&(!ok1||!ok2);

  if(alleenTeken)
    return `Je antwoord is niet juist. Let op het toestandsteken!<br>Het juiste antwoord is ${cB1} en ${cB2}.`;

  const delen=[];
  if(!ok1) delen.push(`de breuk ${biHTML(antB1.teller,antB1.noemer)} is niet gelijk aan de breuk ${biHTML(b1.t,b1.n)}`);
  if(!ok2) delen.push(`de breuk ${biHTML(antB2.teller,antB2.noemer)} is niet gelijk aan de breuk ${biHTML(b2.t,b2.n)}`);
  return `Je antwoord is niet juist. De breuken hebben wel dezelfde noemer, maar ${delen.join(' en ')}.<br>Het juiste antwoord is ${cB1} en ${cB2}.`;
}

/* â”€â”€â”€ Eindscherm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toonEindscherm() {
  updateVoortgang();
  let sc,em,ber;
  if(punten>=5){sc='A';em='ğŸŒŸ';ber='Uitstekend! Je maakt breuken gelijknamig als een pro.';}
  else if(punten>=4){sc='B';em='ğŸ˜Š';ber='Goed gedaan! Nog een beetje oefenen en je hebt het helemaal onder de knie.';}
  else{sc='C';em='ğŸ“š';ber='Blijf oefenen. Je kan dit zeker verbeteren!';}
  document.getElementById('inhoud').innerHTML=`
    <div class="eindscherm">
      <div class="eind-emoji">${em}</div>
      <div class="eind-punten">${punten}/6</div>
      <div class="eind-score-label">Je haalde ${punten}/6</div>
      <div class="score-badge ${sc}">Score: ${sc}</div>
      <div class="eind-bericht">${ber}</div>
      <button class="btn btn-primair" id="terug-btn">â† Terug naar oefeningen</button>
    </div>`;
  document.getElementById('terug-btn').addEventListener('click',()=>{ window.location.href='index.html'; });
  slaanOp(sc);
}

async function slaanOp(sc) {
  try {
    await updateDoc(doc(db,'leerlingen',user.email),{resultaten:arrayUnion({
      type:TYPE_NR,datum:new Date().toISOString(),score:sc,
      totaal:punten,eerste:eerstePoging,tweede:tweedePoging,fout:foutGegaan
    })});
  } catch(e){ console.error('Opslaan mislukt:',e); }
}

/* â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
user=checkLogin();
if(user){ opgaven=genereerOpgaven(); toonOefening(); }
</script>
</body>
</html>
